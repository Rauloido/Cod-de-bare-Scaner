<!doctype html>
<html lang="ro">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
        <meta name="theme-color" content="#0f172a">
        <title>Professional POS - Master Edition</title>
        <link rel="manifest" href="manifest.json">
        <style>
            :root {
                --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --success: #10b981;
                --text: #f8fafc; --muted: #94a3b8; --danger: #f43f5e; --warning: #f59e0b;
                --border: rgba(255,255,255,0.1);
                --radius: 12px;
            }

            /* Modul Touch - AjustƒÉri dinamice */
            body.touch-mode { --radius: 20px; font-size: 16px; }
            body.touch-mode .btn { padding: 18px; font-size: 1.1rem; margin: 6px 0; }
            body.touch-mode input, body.touch-mode select { padding: 16px; font-size: 1.1rem; }
            body.touch-mode .cart-item { padding: 15px; }

            body { font-family: 'Inter', system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); transition: all 0.3s ease; height: 100vh; overflow: hidden; }
            
            /* Layout general */
            header { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); height: 50px; }
            .logo-placeholder { height: 35px; width: 35px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; font-weight: bold; font-size: 0.8rem; }
            .logo-placeholder img { max-width: 100%; max-height: 100%; object-fit: contain; }

            .main-grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; height: calc(100vh - 71px); max-width: 1800px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
            
            .content { overflow-y: auto; padding-right: 5px; height: 100%; }

            /* Panouri */
            .panel { display: none; animation: fadeIn 0.3s ease; }
            .panel.active { display: block; }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

            h3 { border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 0; color: var(--accent); }

            /* Scanner */
            .scanner-wrapper { position: relative; width: 100%; background: #000; border-radius: var(--radius); overflow: hidden; aspect-ratio: 16/9; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
            #video { width: 100%; height: 100%; object-fit: cover; }
            .laser { position: absolute; width: 90%; left: 5%; height: 2px; background: var(--danger); top: 50%; box-shadow: 0 0 15px var(--danger); animation: scanLine 2s infinite ease-in-out; z-index: 2; }
            @keyframes scanLine { 0%, 100% { top: 10%; opacity: 0.5; } 50% { top: 90%; opacity: 1; } }
            
            /* Efect scanare reu»ôitƒÉ */
            .scan-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(16, 185, 129, 0.3); z-index: 10; display: none; }

            /* Controale CamerƒÉ */
            .camera-controls { background: var(--card); padding: 10px; border-radius: var(--radius); margin-top: 10px; border: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }

            /* Co»ô */
            .cart-sidebar { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; overflow: hidden; }
            .cart-items { flex: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
            .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.2); margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--border); transition: 0.2s; }
            .cart-item:hover { background: rgba(255,255,255,0.05); }

            /* Istoric */
            .history-item { background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

            /* Formular & Butoane */
            .btn { border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; color: white; padding: 12px 20px; font-size: 0.95rem; }
            .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
            .btn:active { transform: translateY(1px); }
            .btn-primary { background: var(--accent); }
            .btn-success { background: var(--success); }
            .btn-danger { background: var(--danger); }
            .btn-warning { background: var(--warning); color: #000; }
            
            input, select, textarea { background: #0f172a; border: 1px solid var(--border); color: white; padding: 12px; border-radius: 8px; width: 100%; box-sizing: border-box; outline: none; transition: 0.2s; }
            input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }

            /* Navigation */
            .nav-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); padding: 6px; border-radius: 50px; display: flex; gap: 5px; z-index: 1000; border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
            .nav-item { padding: 12px 24px; border-radius: 40px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-weight: 600; transition: all 0.2s; white-space: nowrap; }
            .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
            .nav-item:hover:not(.active) { color: white; }

            /* Responsive */
            @media (max-width: 1024px) {
                .main-grid { grid-template-columns: 1fr; grid-template-rows: auto 1fr; height: auto; padding-bottom: 100px; }
                .cart-sidebar { height: 500px; margin-top: 20px; }
            }

            /* Printing */
            #print-receipt { display: none; }
            @media print {
                body * { display: none !important; }
                #print-receipt { display: block !important; width: 80mm; color: #000 !important; background: #fff !important; padding: 2mm; font-family: 'Courier New', monospace; font-size: 12px; }
                #print-receipt * { display: block !important; }
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
    </head>
    <body>

    <header>
        <div style="display:flex; align-items:center; gap:15px">
            <div id="logo-container" class="logo-placeholder">POS</div>
            <div>
                <h2 id="header-company-name" style="margin:0; font-size:1.1rem">Smart Business POS</h2>
                <small id="connection-status" style="color:var(--success); font-size:0.7rem">‚óè Online</small>
            </div>
        </div>
        <div id="clock" style="font-family:monospace; color:var(--muted); font-weight:bold"></div>
    </header>

    <main class="main-grid">
        <div class="content">
            
            <div id="tab-sale" class="panel active">
                <div class="scanner-wrapper">
                    <video id="video" autoplay playsinline muted></video>
                    <div class="laser"></div>
                    <div id="scan-feedback" class="scan-overlay"></div>
                </div>
                
                <div class="camera-controls">
                    <span style="color:var(--muted)">üì∏ SursƒÉ Video:</span>
                    <select id="camera-select" onchange="changeCamera()">
                        <option value="" disabled selected>Se √ÆncarcƒÉ camerele...</option>
                    </select>
                    <button id="start-camera-btn" class="btn btn-primary" style="margin-left:6px" onclick="startCameraFromUI()">Porne»ôte CamerƒÉ</button>
                    <span id="camera-error" style="color:var(--warning); margin-left:8px; font-size:0.9rem"></span>
                </div>

                <div style="margin-top:20px; display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                    <button class="btn btn-primary" onclick="manualAddPrompt()">
                        <span>‚å®Ô∏è</span> Cod Manual
                    </button>
                    <button class="btn btn-primary" onclick="searchPrompt()">
                        <span>üîç</span> CautƒÉ Nume
                    </button>
                </div>
            </div>

            <div id="tab-inventory" class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h3>üì¶ Gestiune Stoc</h3>
                    <span id="items-count" style="background:var(--card); padding:5px 10px; border-radius:20px; font-size:0.8rem">0 produse</span>
                </div>
                
                <div style="background:var(--card); padding:20px; border-radius:var(--radius); border:1px solid var(--border); margin-bottom:20px">
                    <div style="display:grid; grid-template-columns: 1fr 2fr 1fr auto; gap:10px; align-items:end">
                        <div>
                            <label style="font-size:0.8rem; color:var(--muted)">Cod Bare</label>
                            <input type="text" id="db-code" placeholder="Scan sau tastare...">
                        </div>
                        <div>
                            <label style="font-size:0.8rem; color:var(--muted)">Nume Produs</label>
                            <input type="text" id="db-name" placeholder="Ex: Cola 0.5L">
                        </div>
                        <div>
                            <label style="font-size:0.8rem; color:var(--muted)">Pre»õ (RON)</label>
                            <input type="number" id="db-price" placeholder="0.00" step="0.01">
                        </div>
                        <button class="btn btn-success" style="height:45px" onclick="saveToInventory()">Salvare</button>
                    </div>
                </div>
                <div id="inventory-list" style="display:grid; gap:10px;"></div>
            </div>

            <div id="tab-history" class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h3>üìú Istoric V√¢nzƒÉri</h3>
                    <button class="btn btn-danger" style="padding:8px 15px; font-size:0.8rem" onclick="clearHistory()">»òterge Istoric</button>
                </div>
                <div id="history-list">
                    <div style="text-align:center; padding:40px; color:var(--muted)">Nicio v√¢nzare √ÆnregistratƒÉ.</div>
                </div>
            </div>

            <div id="tab-settings" class="panel">
                <h3>‚öôÔ∏è Configurare Sistem</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px">
                    <div>
                        <h4>üè¢ Date FirmƒÉ (Bon)</h4>
                        <label>Nume FirmƒÉ</label><input type="text" id="set-comp-name" onchange="updateCompSetting('name', this.value)">
                        <div style="height:10px"></div>
                        <label>CUI / CIF</label><input type="text" id="set-comp-cui" onchange="updateCompSetting('cui', this.value)">
                        <div style="height:10px"></div>
                        <label>AdresƒÉ</label><textarea id="set-comp-addr" rows="3" onchange="updateCompSetting('addr', this.value)"></textarea>
                        <div style="height:10px"></div>
                        <label>URL Logo (Imagine)</label><input type="text" id="set-comp-logo" onchange="updateCompSetting('logo', this.value)">
                    </div>
                    <div>
                        <h4>üõ†Ô∏è Preferin»õe & Securitate</h4>
                        <div style="background:rgba(0,0,0,0.2); padding:20px; border-radius:10px; border:1px solid var(--border)">
                            <label style="display:flex; justify-content:space-between; align-items:center; cursor:pointer">
                                <span>üì± Mod Ecran Tactil (Butoane Mari)</span>
                                <input type="checkbox" id="set-touch-toggle" style="width:20px; height:20px" onchange="toggleTouchMode(this.checked)">
                            </label>
                            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0">
                            <label>Cota TVA ImplicitƒÉ (%)</label>
                            <input type="number" id="set-tva" value="19" onchange="updateCompSetting('tva', this.value)">
                            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0">
                            <label>SchimbƒÉ PIN Acces (Default:0000)</label>
                            <input type="password" id="set-pin" placeholder="PIN Nou" onchange="updateCompSetting('pin', this.value)">
                        </div>
                        <button class="btn btn-danger" style="margin-top:20px; width:100%" onclick="hardReset()">‚ö†Ô∏è RESETARE TOTALƒÇ FABRICƒÇ</button>
                    </div>
                </div>
            </div>
        </div>

        <aside class="cart-sidebar">
            <div style="padding:20px; border-bottom:1px solid var(--border); background:rgba(0,0,0,0.2)">
                <h3 style="margin:0; color:white">üõí Co»ô Curent</h3>
            </div>
            <div id="cart-display" class="cart-items">
                <div style="text-align:center; margin-top:50px; color:var(--muted)">
                    Co»ôul este gol.<br>ScaneazƒÉ un produs.
                </div>
            </div>
            <div style="padding:25px; background:rgba(30, 41, 59, 0.95); border-top:1px solid var(--border); box-shadow: 0 -5px 20px rgba(0,0,0,0.3)">
                <div style="display:flex; justify-content:space-between; font-size:1.6rem; font-weight:800; color:var(--success); margin-bottom:15px">
                    <span>TOTAL</span><span id="grand-total">0.00 LEI</span>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px">
                    <input type="number" id="cash-received" placeholder="Numerar..." style="text-align:center; font-size:1.2rem; font-weight:bold">
                    <button class="btn btn-warning" onclick="calcRest()">CalculeazƒÉ Rest</button>
                </div>
                <button class="btn btn-success" style="width:100%; padding:18px; font-size:1.2rem; font-weight:bold; letter-spacing:1px" onclick="finalizeCheckout()">‚úÖ EMITE BON FISCAL</button>
            </div>
        </aside>
    </main>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="switchTab('sale', this)">üì∏ V√¢nzare</button>
        <button class="nav-item" onclick="switchTab('inventory', this)">üì¶ Produse</button>
        <button class="nav-item" onclick="switchTab('history', this)">üìú Istoric</button>
        <button class="nav-item" onclick="accessSettings(this)">‚öôÔ∏è SetƒÉri</button>
    </nav>

    <div id="print-receipt"></div>

    <script>
        // --- CONFIG & STATE ---
        let inventory = JSON.parse(localStorage.getItem('pos_inventory')) || {};
        let company = JSON.parse(localStorage.getItem('pos_company')) || { 
            name: 'Demo Shop SRL', 
            cui: 'RO123456', 
            addr: 'Str. PrincipalƒÉ Nr. 1, Bucure»ôti', 
            logo: '', 
            tva: 19, 
            touch: false,
            pin: '0000'
        };
        let salesHistory = JSON.parse(localStorage.getItem('pos_history')) || [];
        let cart = [];
        let codeReader = null;
        let selectedDeviceId = localStorage.getItem('pos_camera_id') || null;

        // --- INITIALIZARE ---
        window.onload = async () => {
            codeReader = new ZXing.BrowserMultiFormatReader();
            applySettings();
            await initCamera();
            renderInventory();
            renderHistory();
            startClock();
            
            // Check internet status
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
        };

        function startClock() {
            const tick = () => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleTimeString('ro-RO') + ' | ' + now.toLocaleDateString('ro-RO');
            };
            tick();
            setInterval(tick, 1000);
        }

        function updateStatus() {
            const status = document.getElementById('connection-status');
            if(navigator.onLine) {
                status.innerText = "‚óè Online"; status.style.color = "var(--success)";
            } else {
                status.innerText = "‚óè Offline (Local Mode)"; status.style.color = "var(--warning)";
            }
        }

        // --- CAMERA & SCANNING ---
        async function initCamera() {
            const videoSelect = document.getElementById('camera-select');
            const cameraError = document.getElementById('camera-error');

            if(!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                cameraError.innerText = 'Camera indisponibilƒÉ √Æn acest browser.';
                return;
            }

            if(location.protocol === 'file:') {
                cameraError.innerText = 'Serve»ôte fi»ôierul prin HTTPS sau localhost pentru acces camerƒÉ.';
            } else {
                cameraError.innerText = '';
            }

            // Ensure codeReader exists
            if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();

            // Try to get permission, but continue to enumerate devices even if denied
            let permissionGranted = false;
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: true });
                s.getTracks().forEach(t => t.stop());
                permissionGranted = true;
            } catch(e) {
                console.warn('getUserMedia failed (permission?):', e);
                // show request button to allow retry
                if(document.getElementById('request-perm-btn')) document.getElementById('request-perm-btn').style.display = 'inline-flex';
                cameraError.innerText = 'Permite accesul la camerƒÉ pentru a afi»ôa numele dispozitivelor.';
            }

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoInputs = devices.filter(d => d.kind === 'videoinput');

                if(videoInputs.length === 0) {
                    cameraError.innerText = 'Nu au fost detectate camere.';
                    videoSelect.innerHTML = '<option disabled selected>FƒÉrƒÉ camere</option>';
                    return;
                }

                // Populate dropdown even if labels are empty (permission not granted)
                videoSelect.innerHTML = '';
                videoInputs.forEach((device, idx) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${idx + 1}`;
                    videoSelect.appendChild(option);
                });

                // choose stored or first
                if(!selectedDeviceId || !Array.from(videoSelect.options).some(o=>o.value===selectedDeviceId)) {
                    selectedDeviceId = videoInputs[0].deviceId;
                }
                videoSelect.value = selectedDeviceId;

                // If permission already granted, start scanning automatically
                if(permissionGranted) {
                    try { startScanning(selectedDeviceId); cameraError.innerText = ''; } catch(e) { console.error(e); }
                }
            } catch(err) {
                console.error('enumerateDevices error:', err);
                cameraError.innerText = 'Eroare la listarea dispozitivelor.';
            }
        }

        function changeCamera() {
            const select = document.getElementById('camera-select');
            selectedDeviceId = select.value;
            localStorage.setItem('pos_camera_id', selectedDeviceId);
            try { codeReader.reset(); } catch(e) {}
            startScanning(selectedDeviceId);
        }

        // Manual start from UI (useful when permission wasn't auto-granted)
        function startCameraFromUI() {
            const cameraError = document.getElementById('camera-error');
            try {
                if(!codeReader) codeReader = new ZXing.BrowserMultiFormatReader();
                const select = document.getElementById('camera-select');
                if(!select || !select.value) {
                    cameraError.innerText = 'SelecteazƒÉ o camerƒÉ din lista de l√¢ngƒÉ buton.';
                    return;
                }
                cameraError.innerText = '';
                selectedDeviceId = select.value;
                localStorage.setItem('pos_camera_id', selectedDeviceId);
                try { codeReader.reset(); } catch(e) {}
                startScanning(selectedDeviceId);
            } catch(err) {
                console.error('startCameraFromUI error:', err);
                cameraError.innerText = 'Nu s-a putut porni camera. VerificƒÉ permisiunile.';
            }
        }

        function startScanning(deviceId) {
            try { codeReader.reset(); } catch(e) {}

            // Ensure deviceId is valid
            if(!deviceId) {
                console.warn('No deviceId provided to startScanning');
                return;
            }

            // Start scanning; ZXing will attach stream to the video element
            codeReader.decodeFromVideoDevice(deviceId, 'video', (result, err) => {
                if (result) {
                    handleScan(result.text);
                }
                // ignore intermittent errors to avoid flooding console
            }).catch(e => {
                console.error('Failed to start decoding from video device:', e);
            });
        }

        async function requestCameraPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                // stop tracks immediately ‚Äî we only needed permission to enumerate devices
                stream.getTracks().forEach(t => t.stop());
                const btn = document.getElementById('request-perm-btn');
                if(btn) btn.style.display = 'none';
                // re-init camera flow now that permission is granted
                await initCamera();
            } catch(err) {
                console.error('Permission request failed:', err);
                alert('Permisiune refuzatƒÉ. VerificƒÉ setƒÉrile browserului pentru a permite accesul la camerƒÉ.');
            }
        }

        function handleScan(code) {
            // Prevenire scanare dublƒÉ rapidƒÉ (debounce simplu)
            if(window.lastScan === code && (Date.now() - window.lastScanTime) < 1500) return;
            window.lastScan = code;
            window.lastScanTime = Date.now();

            // Feedback vizual »ôi auditiv
            beep();
            flashScreen();
            if(navigator.vibrate) navigator.vibrate(200);

            // LogicƒÉ produs
            if (inventory[code]) {
                addToCart(inventory[code]);
            } else {
                // Mod adƒÉugare rapidƒÉ
                if(confirm(`Produs necunoscut (${code}). Vrei sƒÉ √Æl adaugi?`)) {
                    document.getElementById('db-code').value = code;
                    switchTab('inventory', document.querySelectorAll('.nav-item')[1]);
                    document.getElementById('db-name').focus();
                }
            }
        }

        function flashScreen() {
            const overlay = document.getElementById('scan-feedback');
            overlay.style.display = 'block';
            setTimeout(() => { overlay.style.display = 'none'; }, 200);
        }

        // --- NAVIGARE SECURIATƒÇ ---
        function switchTab(id, btn) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('tab-' + id).classList.add('active');
            if(btn) btn.classList.add('active');

            // Gestionare camerƒÉ: Oprire dacƒÉ nu suntem pe v√¢nzare pentru a economisi baterie
            if(id === 'sale') {
                if(selectedDeviceId) startScanning(selectedDeviceId);
            } else {
                codeReader.reset();
            }
        }

        function accessSettings(btn) {
            const inputPin = prompt("üîí Introdu PIN-ul de securitate:");
            if(inputPin === company.pin) {
                switchTab('settings', btn);
            } else {
                alert("PIN Incorect!");
            }
        }

        // --- CART LOGIC ---
        function addToCart(product) {
            const existing = cart.find(i => i.code === product.code);
            if(existing) existing.qty++;
            else cart.push({...product, qty: 1});
            updateCartUI();
        }

        function updateCartUI() {
            const display = document.getElementById('cart-display');
            if(cart.length === 0) {
                display.innerHTML = '<div style="text-align:center; margin-top:50px; color:var(--muted)">Co»ôul este gol.<br>ScaneazƒÉ un produs.</div>';
                document.getElementById('grand-total').innerText = "0.00 LEI";
                return;
            }

            display.innerHTML = cart.map((item, idx) => `
                <div class="cart-item">
                    <div style="flex:1">
                        <div style="font-weight:bold; font-size:1.05rem">${item.name}</div>
                        <small style="color:var(--muted)">${item.code}</small>
                    </div>
                    <div style="text-align:right; margin-right:10px">
                        <div>${item.qty} x ${item.price.toFixed(2)}</div>
                        <div style="font-weight:bold">${(item.qty * item.price).toFixed(2)}</div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:2px">
                        <button class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem" onclick="modQty(${idx}, 1)">+</button>
                        <button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem" onclick="modQty(${idx}, -1)">-</button>
                    </div>
                </div>
            `).join('');

            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('grand-total').innerText = total.toFixed(2) + " LEI";
        }

        function modQty(idx, amount) {
            cart[idx].qty += amount;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            updateCartUI();
        }

        function manualAddPrompt() {
            const code = prompt("Introdu manual codul:");
            if(code) handleScan(code);
        }

        function searchPrompt() {
            const term = prompt("CautƒÉ dupƒÉ nume:");
            if(!term) return;
            const found = Object.values(inventory).find(p => p.name.toLowerCase().includes(term.toLowerCase()));
            if(found) addToCart(found);
            else alert("Produsul nu a fost gƒÉsit.");
        }

        function calcRest() {
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const received = parseFloat(document.getElementById('cash-received').value);
            if(!received) return;
            alert(`REST DE PLATƒÇ: ${(received - total).toFixed(2)} LEI`);
        }

        // --- CHECKOUT & PRINT ---
        function finalizeCheckout() {
            if(cart.length === 0) return alert("Co»ô gol!");
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const receivedVal = document.getElementById('cash-received').value;
            const received = receivedVal ? parseFloat(receivedVal) : total;

            if(received < total) return alert(`Suma este prea micƒÉ! Lipsesc ${(total - received).toFixed(2)} LEI`);

            // Creare obiect v√¢nzare
            const saleData = {
                id: Date.now(),
                date: new Date().toLocaleString('ro-RO'),
                items: [...cart],
                total: total,
                received: received,
                company: {...company}
            };

            // Salvare √Æn istoric
            salesHistory.unshift(saleData);
            if(salesHistory.length > 50) salesHistory.pop(); // PƒÉstrƒÉm ultimele 50
            localStorage.setItem('pos_history', JSON.stringify(salesHistory));
            renderHistory();

            // Printare
            printReceipt(saleData);

            // Reset
            cart = [];
            document.getElementById('cash-received').value = '';
            updateCartUI();
        }

        function printReceipt(data) {
            const tvaCota = parseFloat(data.company.tva) / 100;
            const tvaVal = data.total - (data.total / (1 + tvaCota));
            
            const receiptHTML = `
                <center>
                    ${data.company.logo ? `<img src="${data.company.logo}" style="max-width:40mm; display:block; margin:0 auto"><br>` : ''}
                    <h2 style="margin:0">${data.company.name}</h2>
                    <div>CUI: ${data.company.cui}</div>
                    <div>${data.company.addr.replace(/\n/g, '<br>')}</div>
                    <div>--------------------------------</div>
                    <h3 style="margin:5px 0">BON FISCAL</h3>
                    <div>Nr: ${data.id}</div>
                    <div>Data: ${data.date}</div>
                    <div>--------------------------------</div>
                </center>
                <div style="text-align:left">
                    ${data.items.map(i => `
                        <div style="display:flex;justify-content:space-between; margin-bottom:2px">
                            <span>${i.name}<br><small>${i.qty} x ${i.price.toFixed(2)}</small></span>
                            <span style="align-self:end">${(i.price * i.qty).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                <center>
                    <div>--------------------------------</div>
                </center>
                <div style="display:flex;justify-content:space-between;font-weight:bold;font-size:1.2em; margin:5px 0">
                    <span>TOTAL</span><span>${data.total.toFixed(2)} LEI</span>
                </div>
                <div style="font-size:0.8em; text-align:right">din care TVA (${data.company.tva}%): ${tvaVal.toFixed(2)}</div>
                <br>
                <div style="display:flex;justify-content:space-between"><span>Numerar:</span><span>${data.received.toFixed(2)}</span></div>
                <div style="display:flex;justify-content:space-between"><span>Rest:</span><span>${(data.received - data.total).toFixed(2)}</span></div>
                <center>
                    <br>*** VƒÇ MUL»öUMIM! ***<br>
                </center>
            `;
            
            const printZone = document.getElementById('print-receipt');
            printZone.innerHTML = receiptHTML;
            window.print();
        }

        // --- GESTIUNE STOC & ISTORIC ---
        function saveToInventory() {
            const code = document.getElementById('db-code').value.trim();
            const name = document.getElementById('db-name').value.trim();
            const price = parseFloat(document.getElementById('db-price').value);

            if(!code || !name || isNaN(price) || price <= 0) {
                return alert("Te rog completeazƒÉ toate c√¢mpurile corect!");
            }

            inventory[code] = { code, name, price };
            localStorage.setItem('pos_inventory', JSON.stringify(inventory));
            
            // CurƒÉ»õare input-uri
            document.getElementById('db-code').value = '';
            document.getElementById('db-name').value = '';
            document.getElementById('db-price').value = '';
            
            renderInventory();
            alert("Produs Salvat!");
        }

        function renderInventory() {
            const list = document.getElementById('inventory-list');
            const items = Object.values(inventory);
            document.getElementById('items-count').innerText = `${items.length} produse`;

            list.innerHTML = items.map(p => `
                <div class="cart-item" style="background:var(--card)">
                    <div>
                        <div style="font-weight:bold">${p.name}</div>
                        <small style="color:var(--muted)">Cod: ${p.code}</small>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px">
                        <span style="font-weight:bold; color:var(--success)">${p.price.toFixed(2)} LEI</span>
                        <button class="btn btn-danger" style="padding:5px 10px" onclick="deleteProd('${p.code}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function deleteProd(code) {
            if(confirm("Sigur »ôtergi produsul?")) {
                delete inventory[code];
                localStorage.setItem('pos_inventory', JSON.stringify(inventory));
                renderInventory();
            }
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            if(salesHistory.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Nicio v√¢nzare √ÆnregistratƒÉ.</div>';
                return;
            }

            list.innerHTML = salesHistory.map(sale => `
                <div class="history-item">
                    <div>
                        <div style="font-weight:bold">${sale.date}</div>
                        <small style="color:var(--muted)">${sale.items.length} produse</small>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center">
                        <span style="font-weight:bold; font-size:1.1rem">${sale.total.toFixed(2)} LEI</span>
                        <button class="btn btn-primary" style="padding:8px 12px" onclick='reprintHistory(${JSON.stringify(sale)})'>üñ®Ô∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function reprintHistory(saleObj) {
            printReceipt(saleObj);
        }

        function clearHistory() {
            if(confirm("Sigur »ôtergi tot istoricul?")) {
                salesHistory = [];
                localStorage.setItem('pos_history', JSON.stringify(salesHistory));
                renderHistory();
            }
        }

        // --- GESTIUNE SETƒÇRI ---
        function applySettings() {
            document.getElementById('header-company-name').innerText = company.name;
            document.getElementById('set-comp-name').value = company.name;
            document.getElementById('set-comp-cui').value = company.cui;
            document.getElementById('set-comp-addr').value = company.addr;
            document.getElementById('set-comp-logo').value = company.logo;
            document.getElementById('set-tva').value = company.tva;
            document.getElementById('set-touch-toggle').checked = company.touch;
            document.getElementById('set-pin').value = company.pin;
            
            if(company.logo) {
                document.getElementById('logo-container').innerHTML = `<img src="${company.logo}">`;
            } else {
                document.getElementById('logo-container').innerText = "POS";
            }
            toggleTouchMode(company.touch);
        }

        function updateCompSetting(key, val) {
            company[key] = val;
            localStorage.setItem('pos_company', JSON.stringify(company));
            applySettings();
        }

        function toggleTouchMode(enabled) {
            updateCompSetting('touch', enabled);
            if(enabled) document.body.classList.add('touch-mode');
            else document.body.classList.remove('touch-mode');
        }

        function hardReset() {
            if(confirm("ATEN»öIE! Se vor »ôterge toate produsele, istoricul »ôi setƒÉrile.\nE»ôti sigur?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- UTILITARE ---
        function beep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = 1200;
            osc.type = 'sine';
            gain.gain.value = 0.1;
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
        }
    </script>
    </body>
</html>