<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Barcode Generator & Scanner</title>
        <link rel="manifest" href="manifest.json">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="Barcode App">
        <link rel="apple-touch-icon" href="icon-192.png">

                    <div>
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <strong>Products</strong>
                            <div class="actions">
                                <button id="btn-export">Export Excel</button>
                                <button id="btn-import">Import Excel</button>
                                <input id="import-file" type="file" accept=".xlsx,.xls,.csv" style="display:none">
                            </div>
                        </div>

                        <div id="products-list" style="margin-top:8px;max-height:420px;overflow:auto"></div>
                    </div>
                </div>
            </div>

            <div id="panel-scan" class="panel" style="display:none">
                <div style="display:flex;gap:12px;flex-direction:column">
                    <div style="display:flex;gap:8px;align-items:center">
                        <button id="btn-start-scan">Start Camera Scan</button>
                        <button id="btn-stop-scan" disabled>Stop</button>
                        <button id="btn-capture" title="Freeze frame and attempt decode">Capture</button>
                        <button id="btn-resume" style="display:none" title="Resume live scanning">✕</button>
                        <button id="btn-focus" title="Try to autofocus">Focus</button>
                        <select id="camera-select" aria-label="Camera select" style="margin-left:8px"></select>
                        <small class="hint">Tip: allow camera, align barcode with the red line</small>
                    </div>

                    <div class="scanner-wrap" style="height:420px">
                        <video id="video" playsinline></video>
                        <div class="scanner-overlay">
                            <div class="scanner-guide"></div>
                            <div class="red-line" aria-hidden="true"></div>
                            <div class="scan-flash" id="scan-flash"></div>
                            <canvas id="capture-canvas" style="position:absolute;left:0;top:0;width:100%;height:100%;display:none;border-radius:8px"></canvas>
                        </div>
                    </div>

                    <div id="scan-result" style="display:flex;gap:12px;align-items:flex-start">
                        <div style="flex:1">
                            <strong>Result</strong>
                            <div id="result-text" style="padding:8px;border:1px solid #eee;border-radius:6px;background:#fafafa;min-height:70px"></div>
                        </div>
                        <div style="width:260px">
                            <strong>Found product</strong>
                            <div id="found-product" style="padding:8px;border:1px solid #eee;border-radius:6px;background:#fff;min-height:70px"></div>
                        </div>
                    </div>
                </div>
            </div>

            <footer>
                <div><small class="hint">To add to iPhone home screen: open in Safari → Share → Add to Home Screen.</small></div>
            </footer>
        </main>

        <script>
            // Storage key
            const STORAGE_KEY = 'products-db-v1';

            // DOM
            const tabGenerate = document.getElementById('tab-generate');
            const tabScan = document.getElementById('tab-scan');
            const panelGenerate = document.getElementById('panel-generate');
            const panelScan = document.getElementById('panel-scan');

            const pname = document.getElementById('pname');
            const pdesc = document.getElementById('pdesc');
            const pstock = document.getElementById('pstock');
            const pcode = document.getElementById('pcode');
            const pimage = document.getElementById('pimage');
            const btnGenerate = document.getElementById('btn-generate');
            const btnSave = document.getElementById('btn-save');
            const btnDownload = document.getElementById('btn-download');
            const barcodeSvg = document.getElementById('barcode');

            const productsList = document.getElementById('products-list');
            const btnExport = document.getElementById('btn-export');
            const btnImport = document.getElementById('btn-import');
            const importFile = document.getElementById('import-file');

            // Scan elements
            const video = document.getElementById('video');
            const btnStartScan = document.getElementById('btn-start-scan');
            const btnStopScan = document.getElementById('btn-stop-scan');
            const resultText = document.getElementById('result-text');
            const foundProduct = document.getElementById('found-product');

            let products = [];
            let currentBarcodeValue = '';
            let codeReader = null;
            let selectedImageBase64 = null;
            let scanningPaused = false;
            let lastScanned = {value:null, ts:0};
            const SCAN_COOLDOWN = 1400; // ms
            const cameraSelect = document.getElementById('camera-select');
            // hidden canvas to crop video center for scanning (improves detection reliability)
            const scanCanvas = document.createElement('canvas');
            const scanCtx = scanCanvas.getContext('2d');
            let currentStream = null;
            let scanningActive = false;
            let scanLoopHandle = null;

            // Tabs (switch panels and manage camera)
            tabGenerate.onclick = ()=>{tabGenerate.classList.add('active');tabScan.classList.remove('active');panelGenerate.style.display='block';panelScan.style.display='none'; stopCameraScan(); }
            tabScan.onclick = ()=>{tabScan.classList.add('active');tabGenerate.classList.remove('active');panelScan.style.display='block';panelGenerate.style.display='none'; startCameraScan(); }

            // Load/save
            function loadProducts(){
                try{
                    const raw=localStorage.getItem(STORAGE_KEY);
                    products = raw?JSON.parse(raw):[];
                }catch(e){products=[]}
                renderProducts();
            }
            function saveProducts(){localStorage.setItem(STORAGE_KEY,JSON.stringify(products));renderProducts();}

            function renderProducts(){
                productsList.innerHTML='';
                if(!products.length){productsList.innerHTML='<div class="hint">No products yet.</div>';return}
                products.slice().reverse().forEach((p,idx)=>{
                    const el=document.createElement('div');el.className='product';
                    el.innerHTML = `<div style="display:flex;gap:8px"><div style="width:76px;height:76px;flex:0 0 76px;border:1px solid #eee;border-radius:6px;display:flex;align-items:center;justify-content:center">${p.image?'<img src="'+p.image+'" class="thumb">':'<small class="hint">No image</small>'}</div><div style="flex:1"><strong>${escapeHtml(p.name)}</strong><div style="font-size:13px;color:#555">${escapeHtml(p.desc)}</div><div style="margin-top:6px"><strong>Code:</strong> ${p.code} • <strong>Stock:</strong> ${escapeHtml(p.stock)}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button data-code="${p.code}" class="btn-copy">Copy</button><button data-code="${p.code}" class="btn-delete">Delete</button></div></div>`;
                    productsList.appendChild(el);
                });
                // attach handlers
                document.querySelectorAll('.btn-delete').forEach(btn=>btn.onclick=(e)=>{const c=e.target.dataset.code;products=products.filter(p=>p.code!==c);saveProducts();});
                document.querySelectorAll('.btn-copy').forEach(btn=>btn.onclick=(e)=>{navigator.clipboard?.writeText(e.target.dataset.code);alert('Copied '+e.target.dataset.code)});
            }

            function escapeHtml(s){if(!s) return ''; return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

            // Barcode generation
            btnGenerate.onclick = ()=>{
                const val = pcode.value.trim() || generateNumericCode();
                currentBarcodeValue = val;
                try{
                    JsBarcode(barcodeSvg, val, {format: 'CODE128', displayValue: true, width:2, height:60});
                    btnSave.disabled = false;
                    btnDownload.disabled = false;
                }catch(err){alert('Barcode generation failed: '+err.message)}
            }

            // image upload
            pimage.onchange = (e)=>{
                const f=e.target.files[0];
                if(!f) return selectedImageBase64=null;
                const fr=new FileReader();
                fr.onload=()=>{selectedImageBase64=fr.result};fr.readAsDataURL(f);
            }

            btnSave.onclick = ()=>{
                if(!currentBarcodeValue){alert('Generate barcode first');return}
                const obj={code:currentBarcodeValue,name:pname.value||'(no name)',desc:pdesc.value||'',stock:pstock.value||'',image:selectedImageBase64||null};
                // avoid duplicates
                products = products.filter(p=>p.code!==obj.code);
                products.push(obj);
                saveProducts();
                // clear form
                pname.value='';pdesc.value='';pstock.value='';pcode.value='';pimage.value='';selectedImageBase64=null;currentBarcodeValue='';barcodeSvg.innerHTML='';btnSave.disabled=true;btnDownload.disabled=true;
            }

            // download barcode PNG
            btnDownload.onclick = ()=>{
                const svg = barcodeSvg.outerHTML;
                const canvas = document.createElement('canvas');
                const svgBlob = new Blob([svg],{type:'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svgBlob);
                const img = new Image();
                img.onload = ()=>{
                    canvas.width = img.width || 600; canvas.height = img.height || 200;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
                    ctx.drawImage(img,0,0);
                    const png = canvas.toDataURL('image/png');
                    const a = document.createElement('a'); a.href = png; a.download = (pname.value||'barcode') + '.png'; a.click();
                    URL.revokeObjectURL(url);
                };
                img.src = url;
            }

            function generateNumericCode(){
                // create an 12-digit-ish numeric code using timestamp + random
                const t = Date.now().toString();
                const rand = Math.floor(Math.random()*900+100).toString();
                return (t+rand).slice(-12);
            }

                        // Excel export with embedded barcode images using ExcelJS
                        btnExport.onclick = async ()=>{
                                if(!products.length){alert('No products to export');return}
                                if(typeof ExcelJS === 'undefined'){alert('ExcelJS not loaded');return}

                                const wb = new ExcelJS.Workbook();
                                const ws = wb.addWorksheet('Products');
                                ws.columns = [
                                    {header:'Image', key:'img', width:18},
                                    {header:'Code', key:'code', width:22},
                                    {header:'Name', key:'name', width:30},
                                    {header:'Description', key:'desc', width:40},
                                    {header:'Stock', key:'stock', width:12}
                                ];

                                // helper: render a barcode SVG to PNG base64 (without prefix)
                                const renderBarcodePngBase64 = (code)=>{
                                    return new Promise((resolve)=>{
                                        try{
                                            const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
                                            JsBarcode(svg, code, {format:'CODE128', displayValue:false, width:2, height:60});
                                            const svgData = new XMLSerializer().serializeToString(svg);
                                            const svgBlob = new Blob([svgData], {type:'image/svg+xml;charset=utf-8'});
                                            const url = URL.createObjectURL(svgBlob);
                                            const img = new Image();
                                            img.onload = ()=>{
                                                const canvas = document.createElement('canvas');
                                                canvas.width = img.naturalWidth || 400;
                                                canvas.height = img.naturalHeight || 120;
                                                const ctx = canvas.getContext('2d');
                                                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
                                                ctx.drawImage(img,0,0);
                                                const dataUrl = canvas.toDataURL('image/png');
                                                URL.revokeObjectURL(url);
                                                resolve(dataUrl.split(',')[1]);
                                            };
                                            img.onerror = ()=>{ URL.revokeObjectURL(url); resolve(null); };
                                            img.src = url;
                                        }catch(err){console.warn('renderBarcode failed',err); resolve(null)}
                                    })
                                };

                                // add rows and images
                                for(let i=0;i<products.length;i++){
                                    const p = products[i];
                                    const base64 = await renderBarcodePngBase64(p.code);
                                    const row = ws.addRow({img:'', code:p.code, name:p.name, desc:p.desc, stock:p.stock});
                                    // row index for ExcelJS is 1-based
                                    if(base64){
                                        try{
                                            const imageId = wb.addImage({base64: base64, extension: 'png'});
                                            // place the image in the first column for this row
                                            ws.addImage(imageId, {tl:{col:0,row:row.number-1}, ext:{width:120, height:60}});
                                            // set row height
                                            ws.getRow(row.number).height = 45;
                                        }catch(err){console.warn('addImage failed',err)}
                                    }
                                }

                                // write workbook to buffer and save
                                try{
                                    const buf = await wb.xlsx.writeBuffer();
                                    saveAs(new Blob([buf]), 'products.xlsx');
                                }catch(err){console.error(err); alert('Export failed: '+err.message)}
                        }

            btnImport.onclick = ()=> importFile.click();
            importFile.onchange = async (e)=>{
                const f = e.target.files[0]; if(!f) return;
                const ext = f.name.split('.').pop().toLowerCase();
                const data = await f.arrayBuffer();
                let workbook;
                try{ workbook = XLSX.read(data, {type:'array'}); }catch(err){alert('Import failed: '+err.message);return}
                const first = workbook.SheetNames[0];
                const arr = XLSX.utils.sheet_to_json(workbook.Sheets[first]);
                if(!arr.length){alert('No rows found');return}
                // Map rows to products, expecting Code/Name/Description/Stock columns (case-insensitive)
                arr.forEach(r=>{
                    const code = r.Code||r.code||r['Barcode']||'';
                    const name = r.Name||r.name||'';
                    const desc = r.Description||r.description||r.Desc||'';
                    const stock = r.Stock||r.stock||'';
                    if(!code) return;
                    // keep existing image if any
                    const existing = products.find(p=>p.code==code);
                    products = products.filter(p=>p.code!=code);
                    products.push({code, name, desc, stock, image: existing?existing.image:null});
                });
                saveProducts();
                alert('Import complete');
            }


            }

            function stopCameraScan(){
                btnStartScan.disabled = false; btnStopScan.disabled = true; resultText.textContent='';
                // stop ZXing reader if present
                if(codeReader){ try{ codeReader.reset(); }catch(e){console.warn(e)} }
                // stop any active scanning loop
                scanningActive = false;
                if(scanLoopHandle){ try{ if(typeof scanLoopHandle === 'number') cancelAnimationFrame(scanLoopHandle); else clearTimeout(scanLoopHandle); }catch(e){} scanLoopHandle = null; }
                // stop media tracks
                try{
                    if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
                    if(video && video.srcObject){ const tracks = video.srcObject.getTracks(); tracks.forEach(t=>t.stop()); video.srcObject = null; }
                }catch(e){ console.warn('Error stopping stream', e); }
                currentStream = null;
                scanningPaused = false; lastScanned = {value:null, ts:0};
            }

            // bind buttons
            btnStartScan.onclick = startCameraScan;
            btnStopScan.onclick = stopCameraScan;
            cameraSelect.onchange = ()=>{ if(scanningActive){ stopCameraScan(); startCameraScan(); } }
            const btnCapture = document.getElementById('btn-capture');
            const btnResume = document.getElementById('btn-resume');
            const btnFocus = document.getElementById('btn-focus');
            const captureCanvas = document.getElementById('capture-canvas');
            const captureCtx = captureCanvas.getContext('2d');
            let frozen = false;

            // Capture (freeze) current frame and try immediate decode
            btnCapture.onclick = async ()=>{
                if(!video.srcObject){ alert('Camera not started'); return; }
                // draw current frame into capture canvas sized to video pixel size
                const vw = video.videoWidth || video.clientWidth;
                const vh = video.videoHeight || video.clientHeight;
                if(!vw || !vh){ alert('Video not ready yet'); return; }
                captureCanvas.width = vw; captureCanvas.height = vh;
                captureCtx.drawImage(video, 0, 0, vw, vh);
                // show canvas overlay (freeze effect)
                captureCanvas.style.display = 'block';
                video.style.display = 'none';
                frozen = true;
                // stop live decoding
                try{ if(codeReader) codeReader.reset(); }catch(e){console.warn(e)}
                // try decode from the frozen canvas using BarcodeDetector if available
                try{
                    let found = false;
                    if('BarcodeDetector' in window){
                        const detector = new BarcodeDetector({formats:['ean_13','code_128','ean_8','upc_e','upc_a']});
                        const barcodes = await detector.detect(captureCanvas);
                        if(barcodes && barcodes.length){ const v = barcodes[0].rawValue; resultText.textContent = v; onBarcodeScanned(v); found = true; }
                    }

                    // If not found, try rotated variants and ZXing fallback
                    if(!found){
                        // helper to try ZXing decode on a canvas (and rotated versions)
                        const tryZXingOnCanvas = async (c)=>{
                            // try ZXing decode methods if available
                            try{
                                const dataUrl = c.toDataURL();
                                const img = new Image();
                                img.src = dataUrl;
                                await new Promise(r=>{ img.onload = r; img.onerror = r; });
                                if(codeReader && typeof codeReader.decodeFromImageElement === 'function'){
                                    try{
                                        const res = await codeReader.decodeFromImageElement(img);
                                        if(res){ const text = (res.getText)?res.getText():res; resultText.textContent = text; onBarcodeScanned(text); return true; }
                                    }catch(e){ /* continue */ }
                                }
                                // try creating a temporary reader
                                const tmp = new ZXing.BrowserMultiFormatReader();
                                try{
                                    const tres = await tmp.decodeFromImageElement(img);
                                    if(tres){ const t = (tres.getText)?tres.getText():tres; resultText.textContent = t; onBarcodeScanned(t); return true; }
                                }catch(e){ /* ignore */ }
                            }catch(err){ console.warn('ZXing canvas decode failed', err); }
                            return false;
                        };

                        // try original orientation then rotate 90/270
                        let tried = false;
                        tried = await tryZXingOnCanvas(captureCanvas);
                        if(!tried){
                            // rotate 90
                            const rc = document.createElement('canvas');
                            rc.width = captureCanvas.height; rc.height = captureCanvas.width;
                            const rcctx = rc.getContext('2d');
                            rcctx.translate(rc.width/2, rc.height/2);
                            rcctx.rotate(Math.PI/2);
                            rcctx.drawImage(captureCanvas, -captureCanvas.width/2, -captureCanvas.height/2);
                            tried = await tryZXingOnCanvas(rc);
                        }
                        if(!tried){
                            // rotate 270
                            const rc2 = document.createElement('canvas');
                            rc2.width = captureCanvas.height; rc2.height = captureCanvas.width;
                            const rc2ctx = rc2.getContext('2d');
                            rc2ctx.translate(rc2.width/2, rc2.height/2);
                            rc2ctx.rotate(-Math.PI/2);
                            rc2ctx.drawImage(captureCanvas, -captureCanvas.width/2, -captureCanvas.height/2);
                            tried = await tryZXingOnCanvas(rc2);
                        }

                        if(!tried && !found) resultText.textContent = '(No code detected in frozen image)';
                    }
                }catch(err){ console.warn('Frozen decode error', err); resultText.textContent = '(Error decoding frozen image)'; }
                // show resume button
                btnResume.style.display = 'inline-block';
            };

            // Resume scanning: hide capture canvas and restart live scanning
            btnResume.onclick = async ()=>{
                if(frozen){
                    captureCanvas.style.display = 'none';
                    video.style.display = 'block';
                    frozen = false;
                    btnResume.style.display = 'none';
                    // restart scanning
                    startCameraScan();
                }
            };

            // Focus button: best-effort applyConstraints to request autofocus
            btnFocus.onclick = async ()=>{
                if(!video.srcObject){ alert('Camera not started'); return; }
                try{
                    const track = video.srcObject.getVideoTracks()[0];
                    if(!track){ alert('No video track'); return; }
                    const caps = track.getCapabilities ? track.getCapabilities() : {};
                    if(caps.focusMode){
                        await track.applyConstraints({advanced:[{focusMode: 'continuous'}]});
                        alert('Requested continuous focus (if supported).');
                        return;
                    }
                    if(caps.focusDistance){
                        const min = caps.focusDistance.min || 0;
                        const max = caps.focusDistance.max || min;
                        const mid = (min+max)/2;
                        await track.applyConstraints({advanced:[{focusDistance: mid}]});
                        alert('Requested focus distance (if supported).');
                        return;
                    }
                    // attempt a quick restart to trigger autofocus on some devices
                    alert('Auto-focus not directly supported; restarting camera to trigger AF');
                    stopCameraScan();
                    setTimeout(()=>startCameraScan(),200);
                }catch(err){ console.warn(err); alert('Focus request failed: '+err.message); }
            };

            function onBarcodeScanned(value){
                const p = products.find(x=>x.code==value);
                if(p){
                    foundProduct.innerHTML = `<div><strong>${escapeHtml(p.name)}</strong><div style="font-size:13px;color:#555">${escapeHtml(p.desc)}</div><div style="margin-top:6px"><strong>Code:</strong> ${p.code} • <strong>Stock:</strong> ${escapeHtml(p.stock)}</div>${p.image?'<div style="margin-top:8px"><img src="'+p.image+'" class="thumb"></div>':''}</div>`;
                }else{
                    foundProduct.innerHTML = '<div class="hint">Product not found in database.</div>';
                }
            }

            // init
            loadProducts();

            // show PWA install prompt guidance
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); window.deferredPrompt = e; });
        </script>
    </body>
</html>