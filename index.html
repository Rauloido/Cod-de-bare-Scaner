<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Barcode Generator & Scanner</title>
        <link rel="manifest" href="manifest.json">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-title" content="Barcode App">
        <link rel="apple-touch-icon" href="icon-192.png">
        <style>
            :root{--bg:#f6f7fb;--header:#3b82f6;--panel:#ffffff;--text:#111;--muted:#666}
            .dark-mode{--bg:#0f1720;--header:#9e0909;--panel:#26323f;--text:#e6eef6;--muted:#98a6b3}
            body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0;background:var(--bg);color:var(--text)}
            header{padding:12px 16px;background:var(--header);color:white}
            .wrap{max-width:980px;margin:18px auto;padding:12px}
            .tabs{display:flex;gap:8px;margin-bottom:12px}
            button.tab{padding:10px 14px;border:1px solid rgba(0,0,0,0.06);background:var(--panel);border-radius:6px;color:var(--text)}
            button.tab.active{background:#111;color:white}
            .panel{background:var(--panel);padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
            /* scanner overlay */
            .scanner-wrap{position:relative;border-radius:8px;overflow:hidden;background:#000}
            .scanner-wrap video{display:block;width:100%;height:100%;object-fit:cover;background:#000}
            .scanner-overlay{position:absolute;inset:0;pointer-events:none}
            .scanner-guide{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:80%;height:36%;border:2px dashed rgba(255,255,255,0.6);box-shadow:0 0 0 9999px rgba(0,0,0,0.25) inset;border-radius:8px}
            .red-line{position:absolute;left:10%;right:10%;height:2px;top:50%;transform:translateY(-1px);background:rgba(255,0,0,0.95);box-shadow:0 0 8px rgba(255,0,0,0.6)}
            .scan-flash{position:absolute;inset:0;background:rgba(255,255,255,0.08);opacity:0;transition:opacity .18s ease}
            .scan-active .scan-flash{opacity:1}
            .row{display:flex;gap:12px;align-items:center}
            /* mobile-optimized controls */
            @media(max-width:600px){
                .grid{grid-template-columns:1fr}
                .tabs{flex-direction:row}
                button.tab{flex:1;padding:14px}
                .actions button{padding:10px 12px;font-size:15px}
            }
            .big{padding:12px 16px;border-radius:10px;font-size:16px;border:none}
            input,textarea{width:100%;padding:8px;border:1px solid rgba(0,0,0,0.06);border-radius:6px;background:transparent;color:var(--text)}
            label{font-weight:600;margin-bottom:6px;display:block;margin-top:12px}
            label:first-child{margin-top:0}
            .grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
            img.thumb{max-width:100%;max-height:100%;object-fit:contain;border-radius:6px;}
            .product{border-bottom:1px solid rgba(0,0,0,0.06);padding:8px 0}
            .actions{display:flex;gap:8px}
            small.hint{color:var(--muted)}
            footer{padding:14px;text-align:center;color:var(--muted)}
            #insecure-warning{background:#ffefef;color:#801010;padding:10px;border-radius:6px;margin-bottom:12px;border:1px solid #ffd6d6}
            #perm-hint{margin-top:8px;color:#8b5cf6;font-weight:600}
            /* styles for buttons in generate/scan mode */
            #panel-generate button, #panel-scan button {
                background: var(--header);
                color: white;
                cursor: pointer;
                transition: background 0.2s;
            }
            #panel-generate button:hover, #panel-scan button:hover {
                filter: brightness(1.1);
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
        <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    </head>
    <body>
        <header>
            <div style="max-width:980px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
                <div><strong>Barcode Generator & Scanner</strong></div>
                <div style="display:flex;gap:10px;align-items:center">
                  <div style="font-size:13px;opacity:.95">DouƒÉ moduri: GenereazƒÉ ‚Üî ScaneazƒÉ ‚Ä¢ Func»õioneazƒÉ pe telefoane</div>
                  <button id="btn-darkmode" title="Toggle dark mode" style="padding:6px 10px;border-radius:6px;border:none;background:rgba(255,255,255,0.15);color:white">Dark</button>
                </div>
            </div>
        </header>
        <main class="wrap">
            <div id="insecure-warning" style="display:none">
                <strong>Camera blocatƒÉ:</strong> AceastƒÉ paginƒÉ trebuie sƒÉ fie servitƒÉ prin **HTTPS** (de exemplu, via GitHub Pages) sau de la `localhost` pentru a permite accesul la camerƒÉ. Implementa»õi pe GitHub Pages sau utiliza»õi HTTPS pentru a activa permisiunile camerei.
            </div>
            <div class="tabs">
                <button class="tab active" id="tab-generate">‚ú® GenereazƒÉ Cod</button>
                <button class="tab" id="tab-scan">üîç ScaneazƒÉ Cod</button>
            </div>

            <div id="panel-generate" class="panel">
                <div class="grid">
                    <div>
                        <label for="pname">Nume Produs</label>
                        <input id="pname" placeholder="Nume Produs">

                        <label for="pdesc">Descriere</label>
                        <textarea id="pdesc" rows="3" placeholder="ScurtƒÉ descriere"></textarea>

                        <label for="pstock">NumƒÉr Stoc (SKU / Referin»õƒÉ)</label>
                        <input id="pstock" placeholder="Cantitate sau numƒÉr SKU">

                        <label for="pcode">Valoare Cod de Bare (Op»õional)</label>
                        <input id="pcode" placeholder="LƒÉsa»õi gol pentru a genera un cod numeric automat">

                        <label for="pimage">Imagine Produs (Op»õional)</label>
                        <input id="pimage" type="file" accept="image/*">

                        <div style="margin-top:10px" class="actions">
                            <button id="btn-generate">GenereazƒÉ Cod de Bare</button>
                            <button id="btn-save" disabled>SalveazƒÉ Produs</button>
                        </div>

                        <div style="margin-top:10px;text-align:center">
                            <svg id="barcode"></svg>
                        </div>

                        <div style="margin-top:8px">
                            <button id="btn-download" disabled>DescarcƒÉ Cod de Bare (PNG)</button>
                        </div>
                    </div>

                    <div>
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <strong>Produse Salvate</strong>
                            <div class="actions">
                                <button id="btn-export">ExportƒÉ Excel</button>
                                <button id="btn-import">ImportƒÉ Excel</button>
                                <input id="import-file" type="file" accept=".xlsx,.xls,.csv" style="display:none">
                            </div>
                        </div>

                        <div id="products-list" style="margin-top:8px;max-height:420px;overflow:auto"></div>
                    </div>
                </div>
            </div>

            <div id="panel-scan" class="panel" style="display:none">
                <div style="display:flex;gap:12px;flex-direction:column">
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <button id="btn-start-scan" class="big">Start Camera Scan</button>
                        <button id="btn-stop-scan" disabled class="big">Stop</button>
                        <button id="btn-focus" title="√éncearcƒÉ sƒÉ setezi focalizarea automatƒÉ continuƒÉ" class="big">Focus</button> 
                        <button id="btn-capture" title="√énghea»õƒÉ imaginea »ôi √ÆncearcƒÉ decodarea" class="big">Capture</button>
                        <button id="btn-resume" style="display:none" title="Reia scanarea live" class="big">‚úï Reia</button>
                    </div>
                    <small class="hint">Sfat: Alinia»õi codul de bare cu linia ro»ôie, asigura»õi-vƒÉ cƒÉ este luminƒÉ bunƒÉ.</small>
                    
                    <div id="perm-hint"></div>

                    <div class="scanner-wrap" style="height:420px">
                        <video id="video" playsinline></video>
                        <div class="scanner-overlay">
                            <div class="scanner-guide"></div>
                            <div class="red-line" aria-hidden="true"></div>
                            <div class="scan-flash" id="scan-flash"></div>
                            <canvas id="capture-canvas" style="position:absolute;left:0;top:0;width:100%;height:100%;display:none;border-radius:8px"></canvas>
                        </div>
                    </div>

                    <div id="scan-result" style="display:flex;gap:12px;align-items:flex-start">
                        <div style="flex:1">
                            <strong>Rezultat Scanare</strong>
                            <div id="result-text" style="padding:8px;border:1px solid #eee;border-radius:6px;background:#fafafa;min-height:70px;word-wrap:break-word;"></div>
                        </div>
                        <div style="width:260px">
                            <strong>Produs GƒÉsit (Inventar)</strong>
                            <div id="found-product" style="padding:8px;border:1px solid #eee;border-radius:6px;background:#fff;min-height:70px"></div>
                        </div>
                    </div>
                </div>
            </div>

            <footer>
                <div><small class="hint">Pentru a adƒÉuga pe ecranul principal iPhone: deschide»õi √Æn Safari ‚Üí Partaja»õi ‚Üí AdƒÉuga»õi la ecranul principal.</small></div>
            </footer>
        </main>

        <script>
            // Storage key
            const STORAGE_KEY = 'products-db-v1';

            // DOM
            const tabGenerate = document.getElementById('tab-generate');
            const tabScan = document.getElementById('tab-scan');
            const panelGenerate = document.getElementById('panel-generate');
            const panelScan = document.getElementById('panel-scan');

            const pname = document.getElementById('pname');
            const pdesc = document.getElementById('pdesc');
            const pstock = document.getElementById('pstock');
            const pcode = document.getElementById('pcode');
            const pimage = document.getElementById('pimage');
            const btnGenerate = document.getElementById('btn-generate');
            const btnSave = document.getElementById('btn-save');
            const btnDownload = document.getElementById('btn-download');
            const barcodeSvg = document.getElementById('barcode');

            const productsList = document.getElementById('products-list');
            const btnExport = document.getElementById('btn-export');
            const btnImport = document.getElementById('btn-import');
            const importFile = document.getElementById('import-file');

            // Scan elements
            const video = document.getElementById('video');
            const btnStartScan = document.getElementById('btn-start-scan');
            const btnStopScan = document.getElementById('btn-stop-scan');
            const btnCapture = document.getElementById('btn-capture');
            const btnResume = document.getElementById('btn-resume');
            const btnFocus = document.getElementById('btn-focus'); // Noul buton Focus
            const captureCanvas = document.getElementById('capture-canvas');
            const captureCtx = captureCanvas.getContext('2d');

            const resultText = document.getElementById('result-text');
            const foundProduct = document.getElementById('found-product');

            let products = [];
            let currentBarcodeValue = '';
            let codeReader = null;
            let selectedImageBase64 = null;
            let scanningPaused = false;
            let frozen = false;
            let lastScanned = {value:null, ts:0};
            const SCAN_COOLDOWN = 1400; // ms debounce

            // hidden canvas to crop video center for scanning (improves detection reliability)
            const scanCanvas = document.createElement('canvas');
            const scanCtx = scanCanvas.getContext('2d');

            // ZXing decode hints helper: prefer common linear barcode formats
            function getZXingHints(){
                if(typeof ZXing === 'undefined' || !ZXing.DecodeHintType) return undefined;
                try{
                    const hints = new Map();
                    const fmts = [
                        ZXing.BarcodeFormat.CODE_128,
                        ZXing.BarcodeFormat.EAN_13,
                        ZXing.BarcodeFormat.EAN_8,
                        ZXing.BarcodeFormat.UPC_A,
                        ZXing.BarcodeFormat.UPC_E,
                        ZXing.BarcodeFormat.CODE_39,
                        ZXing.BarcodeFormat.ITF
                    ];
                    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, fmts);
                    return hints;
                }catch(e){ return undefined; }
            }

            // Dark mode toggle
            const btnDark = document.getElementById('btn-darkmode');
            function applyDarkMode(enabled){
                if(enabled) document.documentElement.classList.add('dark-mode'); else document.documentElement.classList.remove('dark-mode');
                localStorage.setItem('dark-mode', enabled? '1':'0');
            }
            btnDark.onclick = ()=>{ const on = !(localStorage.getItem('dark-mode')==='1'); applyDarkMode(on); btnDark.textContent = on? 'Light':'Dark'; };
            if(localStorage.getItem('dark-mode')==='1'){ applyDarkMode(true); btnDark.textContent='Light'; }

            // insecure origin check
            const insecureWarning = document.getElementById('insecure-warning');
            const isSecureContext = (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
            if(!isSecureContext){ insecureWarning.style.display = 'block'; }

            // permission hint UI
            const permHint = document.getElementById('perm-hint');
            function setPermHint(msg, color){ if(!permHint) return; permHint.textContent = msg; if(color) permHint.style.color = color; }

            // Request camera permission proactively
            async function requestCameraPermission(){
                if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
                    setPermHint('Camera not supported by this browser.', '#d97706'); return false;
                }
                if(!isSecureContext){
                    setPermHint('Page not served over HTTPS ‚Äî camera permission will be blocked. Deploy to GitHub Pages or use HTTPS.', '#b91c1c'); return false;
                }
                try{
                    if(navigator.permissions && navigator.permissions.query){
                        try{
                            const p = await navigator.permissions.query({name: 'camera'});
                            if(p.state === 'granted'){ setPermHint('Camera permission already granted.', '#059669'); return true; }
                            if(p.state === 'denied'){ setPermHint('Camera permission was denied. Enable camera access in browser settings.', '#b91c1c'); return false; }
                        }catch(e){ /* ignored */ }
                    }

                    setPermHint('Requesting camera permission...', '#0ea5e9');
                    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
                    stream.getTracks().forEach(t=>t.stop());
                    setPermHint('Camera permission granted. You can start scanning.', '#059669');
                    return true;
                }catch(err){
                    console.warn('getUserMedia error', err);
                    if(err && (err.name === 'NotAllowedError' || err.name === 'SecurityError')){
                        setPermHint('Camera permission blocked. Allow access in the browser prompt or settings.', '#b91c1c');
                    }else if(err && err.name === 'NotFoundError'){
                        setPermHint('No camera found on this device.', '#b91c1c');
                    }else{
                        setPermHint('Camera error: ' + (err && err.message ? err.message : String(err)), '#b91c1c');
                    }
                    return false;
                }
            }

            // Tabs (switch panels and manage camera)
            tabGenerate.onclick = ()=>{tabGenerate.classList.add('active');tabScan.classList.remove('active');panelGenerate.style.display='block';panelScan.style.display='none'; stopCameraScan(); }
            tabScan.onclick = async ()=>{tabScan.classList.add('active');tabGenerate.classList.remove('active');panelScan.style.display='block';panelGenerate.style.display='none';
                const ok = await requestCameraPermission();
                if(ok){ startCameraScan(); }
            }

            // Load/save
            function loadProducts(){
                try{
                    const raw=localStorage.getItem(STORAGE_KEY);
                    products = raw?JSON.parse(raw):[];
                }catch(e){products=[]}
                renderProducts();
            }
            function saveProducts(){localStorage.setItem(STORAGE_KEY,JSON.stringify(products));renderProducts();}

            function renderProducts(){
                productsList.innerHTML='';
                if(!products.length){productsList.innerHTML='<div class="hint">No products yet.</div>';return}
                products.slice().reverse().forEach((p,idx)=>{
                    const el=document.createElement('div');el.className='product';
                    el.innerHTML = `<div style="display:flex;gap:8px"><div style="width:76px;height:76px;flex:0 0 76px;border:1px solid #eee;border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden">${p.image?'<img src="'+p.image+'" class="thumb">':'<small class="hint">No image</small>'}</div><div style="flex:1"><strong>${escapeHtml(p.name)}</strong><div style="font-size:13px;color:var(--muted)">${escapeHtml(p.desc)}</div><div style="margin-top:6px"><strong>Code:</strong> ${p.code} ‚Ä¢ <strong>Stock:</strong> ${escapeHtml(p.stock)}</div></div><div style="display:flex;flex-direction:column;gap:6px"><button data-code="${p.code}" class="btn-copy">Copy</button><button data-code="${p.code}" class="btn-delete">Delete</button></div></div>`;
                    productsList.appendChild(el);
                });
                // attach handlers
                document.querySelectorAll('.btn-delete').forEach(btn=>btn.onclick=(e)=>{if(confirm('Are you sure you want to delete product with code '+e.target.dataset.code+'?')){const c=e.target.dataset.code;products=products.filter(p=>p.code!==c);saveProducts();}});
                document.querySelectorAll('.btn-copy').forEach(btn=>btn.onclick=(e)=>{navigator.clipboard?.writeText(e.target.dataset.code);alert('Copied '+e.target.dataset.code)});
            }

            function escapeHtml(s){if(!s) return ''; return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

            // Barcode generation
            btnGenerate.onclick = ()=>{
                const val = pcode.value.trim() || generateNumericCode();
                currentBarcodeValue = val;
                try{
                    JsBarcode(barcodeSvg, val, {format: 'CODE128', displayValue: true, width:2, height:60});
                    btnSave.disabled = false;
                    btnDownload.disabled = false;
                }catch(err){alert('Barcode generation failed: '+err.message)}
            }

            // image upload
            pimage.onchange = (e)=>{
                const f=e.target.files[0];
                if(!f) return selectedImageBase64=null;
                const fr=new FileReader();
                fr.onload=()=>{selectedImageBase64=fr.result};fr.readAsDataURL(f);
            }

            btnSave.onclick = ()=>{
                if(!currentBarcodeValue){alert('Generate barcode first');return}
                const obj={code:currentBarcodeValue,name:pname.value||'(no name)',desc:pdesc.value||'',stock:pstock.value||'',image:selectedImageBase64||null};
                // avoid duplicates
                products = products.filter(p=>p.code!==obj.code);
                products.push(obj);
                saveProducts();
                // clear form
                pname.value='';pdesc.value='';pstock.value='';pcode.value='';pimage.value='';selectedImageBase64=null;currentBarcodeValue='';barcodeSvg.innerHTML='';btnSave.disabled=true;btnDownload.disabled=true;
            }

            // download barcode PNG
            btnDownload.onclick = ()=>{
                const svg = barcodeSvg.outerHTML;
                const canvas = document.createElement('canvas');
                const svgBlob = new Blob([svg],{type:'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svgBlob);
                const img = new Image();
                img.onload = ()=>{
                    canvas.width = img.width || 600; canvas.height = img.height || 200;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
                    ctx.drawImage(img,0,0);
                    const png = canvas.toDataURL('image/png');
                    const a = document.createElement('a'); a.href = png; a.download = (pname.value||'barcode') + '.png'; a.click();
                    URL.revokeObjectURL(url);
                };
                img.src = url;
            }

            function generateNumericCode(){
                // create an 12-digit-ish numeric code using timestamp + random
                const t = Date.now().toString();
                const rand = Math.floor(Math.random()*900+100).toString();
                return (t+rand).slice(-12);
            }

            // Excel export with embedded barcode images using ExcelJS
            btnExport.onclick = async ()=>{
                    if(!products.length){alert('No products to export');return}
                    if(typeof ExcelJS === 'undefined'){alert('ExcelJS not loaded');return}

                    const wb = new ExcelJS.Workbook();
                    const ws = wb.addWorksheet('Products');
                    ws.columns = [
                        {header:'Barcode Image', key:'img', width:18},
                        {header:'Code', key:'code', width:22},
                        {header:'Name', key:'name', width:30},
                        {header:'Description', key:'desc', width:40},
                        {header:'Stock', key:'stock', width:12}
                    ];

                    // helper: render a barcode SVG to PNG base64 (without prefix)
                    const renderBarcodePngBase64 = (code)=>{
                        return new Promise((resolve)=>{
                            try{
                                const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
                                JsBarcode(svg, code, {format:'CODE128', displayValue:false, width:2, height:60});
                                const svgData = new XMLSerializer().serializeToString(svg);
                                const svgBlob = new Blob([svgData], {type:'image/svg+xml;charset=utf-8'});
                                const url = URL.createObjectURL(svgBlob);
                                const img = new Image();
                                img.onload = ()=>{
                                    const canvas = document.createElement('canvas');
                                    canvas.width = img.naturalWidth || 400;
                                    canvas.height = img.naturalHeight || 120;
                                    const ctx = canvas.getContext('2d');
                                    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
                                    ctx.drawImage(img,0,0);
                                    const dataUrl = canvas.toDataURL('image/png');
                                    URL.revokeObjectURL(url);
                                    resolve(dataUrl.split(',')[1]); // return Base64 string without prefix
                                };
                                img.onerror = ()=>{ URL.revokeObjectURL(url); resolve(null); };
                                img.src = url;
                            }catch(err){console.warn('renderBarcode failed',err); resolve(null)}
                        })
                    };

                    // add rows and images
                    for(let i=0;i<products.length;i++){
                        const p = products[i];
                        const base64 = await renderBarcodePngBase64(p.code);
                        const row = ws.addRow({img:'', code:p.code, name:p.name, desc:p.desc, stock:p.stock});
                        // row index for ExcelJS is 1-based
                        if(base64){
                            try{
                                const imageId = wb.addImage({base64: base64, extension: 'png'});
                                // place the image in the first column for this row
                                ws.addImage(imageId, {tl:{col:0,row:row.number-1}, ext:{width:120, height:60}});
                                // set row height
                                ws.getRow(row.number).height = 45;
                            }catch(err){console.warn('addImage failed',err)}
                        }
                    }

                    // write workbook to buffer and save
                    try{
                        const buf = await wb.xlsx.writeBuffer();
                        saveAs(new Blob([buf]), 'products.xlsx');
                    }catch(err){console.error(err); alert('Export failed: '+err.message)}
            }

            btnImport.onclick = ()=> importFile.click();
            importFile.onchange = async (e)=>{
                const f = e.target.files[0]; if(!f) return;
                const data = await f.arrayBuffer();
                let workbook;
                try{ workbook = XLSX.read(data, {type:'array'}); }catch(err){alert('Import failed: '+err.message);return}
                const first = workbook.SheetNames[0];
                const arr = XLSX.utils.sheet_to_json(workbook.Sheets[first]);
                if(!arr.length){alert('No rows found');return}
                // Map rows to products, expecting Code/Name/Description/Stock columns (case-insensitive)
                arr.forEach(r=>{
                    const code = String(r.Code||r.code||r['Barcode']||'').trim();
                    const name = String(r.Name||r.name||'').trim();
                    const desc = String(r.Description||r.description||r.Desc||'').trim();
                    const stock = String(r.Stock||r.stock||'').trim();
                    if(!code) return;
                    // keep existing image if any
                    const existing = products.find(p=>p.code==code);
                    products = products.filter(p=>p.code!=code);
                    products.push({code, name, desc, stock, image: existing?existing.image:null});
                });
                saveProducts();
                alert('Import complete');
                importFile.value = ''; // clear input
            }

            // Scanning - start/stop helpers with rear-camera preference and debounce
            async function startCameraScan(opts){
                opts = opts || {};
                btnStartScan.disabled = true; btnStopScan.disabled = false; btnFocus.disabled = false; resultText.textContent=''; foundProduct.innerHTML='';
                scanningPaused = false; lastScanned = {value:null, ts:0};
                setPermHint('Scanning started...', '#059669');

                try{
                    // reset any previous reader
                    try{ if(codeReader) { codeReader.reset(); } }catch(e){ console.warn('reset reader', e); }

                    const hints = getZXingHints();
                    codeReader = new ZXing.BrowserMultiFormatReader(hints);
                    video.setAttribute('playsinline', '');

                    const devices = await codeReader.listVideoInputDevices();
                    let preferred = undefined;
                    let deviceId = undefined;
                    
                    if(devices && devices.length){
                        // PreferƒÉ camera din spate (environment/back/rear)
                        const backRegex = /(back|rear|environment|main)/i;
                        preferred = devices.find(d=> backRegex.test(d.label)) || devices[devices.length-1] || devices[0];
                        deviceId = preferred ? preferred.deviceId : undefined;
                    }

                    // Definire constr√¢ngeri media optimizate
                    const mediaConstraints = {
                        video: {
                            deviceId: deviceId ? { exact: deviceId } : undefined,
                            facingMode: deviceId ? undefined : 'environment',
                            // √éncercƒÉm sƒÉ for»õƒÉm o rezolu»õie/framerate mai bun pentru decodare
                            width: { min: 640, ideal: 1280, max: 1920 },
                            height: { min: 480, ideal: 720, max: 1080 },
                            frameRate: { ideal: 30 }
                        }
                    };

                    // start ZXing decode on the chosen device with constraints
                    codeReader.decodeFromVideoDevice(deviceId, video, mediaConstraints, (result, err) => {
                        if(result){
                            const text = result.getText();
                            const now = Date.now();
                            if(scanningPaused) return;
                            if(lastScanned.value === text && (now - lastScanned.ts) < SCAN_COOLDOWN) return;
                            lastScanned = {value:text, ts:now};
                            scanningPaused = true; setTimeout(()=>{scanningPaused=false}, SCAN_COOLDOWN);
                            resultText.textContent = text;
                            const flash = document.getElementById('scan-flash'); if(flash){ flash.classList.add('scan-active'); setTimeout(()=>flash.classList.remove('scan-active'), 180); }
                            onBarcodeScanned(text);
                        }
                        // if(err && !(err instanceof ZXing.NotFoundException)){ console.warn(err); } // less verbose console
                    });
                }catch(e){
                    console.error('ZXing start failed:', e);
                    setPermHint('Eroare la pornirea camerei. √éncerca»õi BarcodeDetector (dacƒÉ este disponibil).', '#b91c1c');
                    // Fallback to BarcodeDetector (if available) - logic remains the same
                    try{
                        const constraints = {video:{facingMode:'environment'}};
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        video.srcObject = stream; video.setAttribute('playsinline',''); await video.play();
                        const detector = ('BarcodeDetector' in window) ? new BarcodeDetector({formats:['ean_13','code_128','ean_8','upc_e','upc_a']}) : null;
                        if(!detector){console.warn('No BarcodeDetector available.');}
                        const scanLoop = async ()=>{
                            if(video.paused || video.ended) return;
                            try{
                                if(detector){
                                    const vw = video.videoWidth || video.clientWidth;
                                    const vh = video.videoHeight || video.clientHeight;
                                    if(vw && vh){
                                        const cw = Math.floor(vw * 0.8); const ch = Math.floor(vh * 0.36);
                                        const sx = Math.floor((vw - cw)/2); const sy = Math.floor((vh - ch)/2);
                                        scanCanvas.width = cw; scanCanvas.height = ch;
                                        scanCtx.drawImage(video, sx, sy, cw, ch, 0, 0, cw, ch);
                                        const barcodes = await detector.detect(scanCanvas);
                                        if(barcodes && barcodes.length){
                                            const v = barcodes[0].rawValue; const now = Date.now(); 
                                            if(lastScanned.value===v && (now-lastScanned.ts)<SCAN_COOLDOWN) return; 
                                            lastScanned={value:v,ts:now}; resultText.textContent=v; 
                                            const flash=document.getElementById('scan-flash'); if(flash){flash.classList.add('scan-active'); setTimeout(()=>flash.classList.remove('scan-active'),180);} 
                                            onBarcodeScanned(v); 
                                        }
                                    }
                                }
                            }catch(err){console.warn(err)}
                            requestAnimationFrame(scanLoop);
                        };
                        scanLoop();
                    }catch(err){
                        alert('Could not start camera: '+err.message);
                        btnStartScan.disabled=false;btnStopScan.disabled=true;btnFocus.disabled=true;
                        setPermHint('Eroare fatalƒÉ la camerƒÉ: ' + (err.message || String(err)), '#b91c1c');
                    }
                }
            }

            function stopCameraScan(){
                btnStartScan.disabled = false; btnStopScan.disabled = true; btnFocus.disabled = true; resultText.textContent='';
                setPermHint('Scanare OpritƒÉ.', '#b91c1c');
                if(codeReader){ try{ codeReader.reset(); }catch(e){console.warn(e)} }
                if(video && video.srcObject){ const tracks = video.srcObject.getTracks(); tracks.forEach(t=>t.stop()); video.srcObject=null; }
                scanningPaused = false; lastScanned = {value:null, ts:0};
                if(frozen){btnResume.click();} // ensure we clean up the frozen frame UI if stopped externally
            }

            // bind buttons
            btnStartScan.onclick = async ()=>{
                const ok = await requestCameraPermission();
                if(ok) startCameraScan();
            };
            btnStopScan.onclick = stopCameraScan;

            // Capture button: freeze frame and try immediate decode
            btnCapture.onclick = async ()=>{
                if(!video.srcObject){
                    const ok = await requestCameraPermission();
                    if(!ok){ return; }
                    await startCameraScan(); // start scanning if not already running
                    return;
                }
                
                // Draw current frame to capture canvas
                const vw = video.videoWidth || video.clientWidth;
                const vh = video.videoHeight || video.clientHeight;
                if(!vw || !vh){ alert('Video not ready yet'); return; }
                captureCanvas.width = vw; captureCanvas.height = vh;
                captureCtx.drawImage(video, 0, 0, vw, vh);

                // UI adjustments
                captureCanvas.style.display = 'block';
                video.style.display = 'none';
                frozen = true;
                btnResume.style.display = 'inline-block';
                btnFocus.disabled = true; // disable focus while frozen
                setPermHint('Frame √Ænghe»õat. √éncerc decodarea...', '#0ea5e9');

                // Stop live decoding
                try{ if(codeReader) codeReader.reset(); }catch(e){console.warn(e)}

                // Try decode from the frozen canvas
                try{
                    let found = false;
                    let detectedValue = null;
                    if('BarcodeDetector' in window){
                        try{
                            const detector = new BarcodeDetector({formats:['ean_13','code_128','ean_8','upc_e','upc_a']});
                            const barcodes = await detector.detect(captureCanvas);
                            if(barcodes && barcodes.length){ detectedValue = barcodes[0].rawValue; found = true; }
                        }catch(e){ console.warn('BarcodeDetector on canvas failed', e); }
                    }
                    if(!found){
                        detectedValue = await decodeCanvasWithZXing(captureCanvas);
                        if(detectedValue) found = true;
                    }
                    
                    if(found){ 
                        resultText.textContent = detectedValue; 
                        onBarcodeScanned(detectedValue); 
                        setPermHint('Decodare reu»ôitƒÉ pe imaginea √Ænghe»õatƒÉ.', '#059669');
                    }else{ 
                        resultText.textContent = '(Niciun cod detectat √Æn imaginea √Ænghe»õatƒÉ)';
                        foundProduct.innerHTML = '<div class="hint">Niciun cod gƒÉsit.</div>';
                        setPermHint('Nu s-a detectat niciun cod. ApƒÉsa»õi "Reia" pentru a continua scanarea.', '#b91c1c');
                    }
                }catch(err){ console.warn('Frozen decode error', err); resultText.textContent = '(Eroare la decodarea imaginii √Ænghe»õate)'; }
            };

            // ZXing fallback: decode from a canvas
            async function decodeCanvasWithZXing(canvas){
                if(typeof ZXing === 'undefined') return null;
                try{
                    const dataUrl = canvas.toDataURL('image/png');
                    const img = new Image();
                    img.src = dataUrl;
                    await new Promise((res, rej)=>{ img.onload = res; img.onerror = rej; });
                    const reader = new ZXing.BrowserMultiFormatReader(getZXingHints());
                    if(typeof reader.decodeFromImageElement === 'function'){
                        const resObj = await reader.decodeFromImageElement(img);
                        if(resObj && resObj.getText) return resObj.getText();
                    }else if(typeof reader.decodeFromImage === 'function'){
                        const resObj = await reader.decodeFromImage(img);
                        if(resObj && resObj.getText) return resObj.getText();
                    }
                }catch(e){ console.warn('ZXing canvas decode failed', e); }
                return null;
            }

            // Resume scanning: hide capture canvas and restart live scanning
            btnResume.onclick = async ()=>{
                if(frozen){
                    captureCanvas.style.display = 'none';
                    video.style.display = 'block';
                    frozen = false;
                    btnResume.style.display = 'none';
                    // restart scanning
                    startCameraScan();
                }
            };

            // Focus button: best-effort applyConstraints to request autofocus
            btnFocus.onclick = async ()=>{
                if(!video.srcObject){ alert('Camera not started'); return; }
                try{
                    const track = video.srcObject.getVideoTracks()[0];
                    if(!track){ alert('No video track'); return; }
                    const caps = track.getCapabilities ? track.getCapabilities() : {}; 
                    
                    // Priority 1: continuous focus mode
                    if(caps.focusMode && caps.focusMode.indexOf('continuous') !== -1){
                        try{
                            await track.applyConstraints({advanced:[{focusMode: 'continuous'}]});
                            setPermHint('S-a solicitat focalizare continuƒÉ automatƒÉ.', '#059669');
                        }catch(e){ console.warn('focus applyConstraints failed', e); setPermHint('Solicitarea de focalizare a e»ôuat. ' + (e && e.message ? e.message : String(e)), '#b91c1c'); }
                        return;
                    }

                    // Priority 2: fixed focus distance (e.g., set to mid-range)
                    if(caps.focusDistance){
                        try{
                            const min = (caps.focusDistance && typeof caps.focusDistance.min === 'number') ? caps.focusDistance.min : 0;
                            const max = (caps.focusDistance && typeof caps.focusDistance.max === 'number') ? caps.focusDistance.max : min;
                            const mid = (min+max)/2;
                            await track.applyConstraints({advanced:[{focusDistance: mid}]});
                            setPermHint('S-a solicitat o distan»õƒÉ de focalizare fixƒÉ.', '#059669');
                        }catch(e){ console.warn('focus distance apply failed', e); setPermHint('Solicitarea de focalizare a e»ôuat. ' + (e && e.message ? e.message : String(e)), '#b91c1c'); }
                        return;
                    }
                    
                    setPermHint('Focalizarea automatƒÉ nu este suportatƒÉ direct. √éncerca»õi sƒÉ mi»ôca»õi camera.', '#b91c1c');
                }catch(err){ console.warn(err); setPermHint('Solicitare Focus E»ôuatƒÉ: '+(err && err.message?err.message:String(err)), '#b91c1c'); }
            };


            function syncCanvasSizes(){
                try{
                    const vw = video.videoWidth || video.clientWidth || 640;
                    const vh = video.videoHeight || video.clientHeight || 480;
                    const overlay = document.getElementById('capture-canvas');
                    if(overlay){ overlay.width = vw; overlay.height = vh; }
                    if(scanCanvas){ scanCanvas.width = Math.floor(vw * 0.8); scanCanvas.height = Math.floor(vh * 0.36); }
                }catch(e){ /* ignore */ }
            }
            window.addEventListener('resize', ()=>{ syncCanvasSizes(); });
            window.addEventListener('orientationchange', ()=>{ setTimeout(syncCanvasSizes, 220); });
            video.addEventListener('loadedmetadata', ()=>{ syncCanvasSizes(); });

            function onBarcodeScanned(value){
                const p = products.find(x=>x.code==value);
                if(p){
                    foundProduct.innerHTML = `<div><strong>${escapeHtml(p.name)}</strong><div style="font-size:13px;color:var(--muted)">${escapeHtml(p.desc)}</div><div style="margin-top:6px"><strong>Code:</strong> ${p.code} ‚Ä¢ <strong>Stock:</strong> ${escapeHtml(p.stock)}</div>${p.image?'<div style="margin-top:8px;height:120px;overflow:hidden;border:1px solid #eee;border-radius:6px;display:flex;align-items:center;justify-content:center"><img src="'+p.image+'" class="thumb"></div>':''}</div>`;
                }else{
                    foundProduct.innerHTML = '<div class="hint" style="color:#d97706;font-weight:bold">Produsul nu a fost gƒÉsit √Æn baza de date.</div>';
                }
            }

            // init
            loadProducts();
            
            // Initial camera check to show hint
            document.addEventListener('DOMContentLoaded', async ()=>{
                if(tabScan.classList.contains('active')){
                    await requestCameraPermission();
                }
            });
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); window.deferredPrompt = e; });
        </script>
    </body>
</html>